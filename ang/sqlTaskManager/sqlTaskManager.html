<div id="bootstrap-theme">
  <h1 crm-page-title>{{ts('SQL Task Manager')}}</h1>

  <div ng-if="isTasksLoading">
    <div class="st__p-10">{{ts('Please wait, tasks is loading ...')}}</div>
    <div class="stm__preloader">
      <div class="crm-container">
        <div class="dataTables_processing"></div>
      </div>
    </div>
  </div>

  <div ng-if="!isTasksLoading">
    <div class="st__mb-20">
      <div class="crm-form-block">
        <div class="st__flex st__gap-10">
          <div>
            <div class="panel panel-info st__width-500">
              <div class="panel-heading st__flex st__align-items-center st__gap-10">
                <div class="st__ico">
                  <i class="crm-i fa-plus-circle"></i>
                </div>
                <span>Add a new task</span>
              </div>
              <div class="panel-body">
                <div>
                  <div>
                    <p class="st__pb-10">
                      {{ts('Select a configuration template for the new task.')}}
                      <br>
                      {{ts('Check out our')}}
                      <a href="https://github.com/systopia/de.systopia.sqltasks/blob/master/tasks/readme.md" target="_blank">
                        {{ts('sample task repository')}}
                      </a>
                      {{ts('for examples to get you started.')}}
                    </p>

                    <div class="st__flex st__align-items-center st__gap-10">
                      <button class="btn btn-success" ng-click="addNewTask()" ng-disabled="selectTemplateModel.templateId === undefined">
                        <i class="crm-i fa-plus"></i>
                        <span>{{ts('Add')}}</span>
                      </button>
                      <select2 id="config-template" name="config-template" isRequired="false" model="selectTemplateModel.templateId" options="templateOptions"></select2>
                      <a class="st__ico" target="_blank" href="{{url('civicrm/sqltasks/templates');}}">
                        <i class="crm-i fa-wrench"></i>
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="panel panel-info st__width-500 st__flex-grow-1 st__m-0">
            <div class="panel-heading st__flex st__align-items-center st__gap-10">
              <div class="st__ico">
                <i class="crm-i fa-info-circle"></i>
              </div>
              <span>Info</span>
            </div>
            <div class="panel-body">
              <div class="st__flex st__gap-15">
                <a class="st__flex st__pb-10 st__gap-5 st__align-items-center" href="{{url('civicrm/sqltasks-execution/list');}}"
                   target="_blank"
                   title="{{ts('Show task execution logs', {'domain' : 'de.systopia.sqltasks'})}}">
                  <div class="st__ico">
                    <i class="crm-i fa-bars"></i>
                  </div>
                  {{ts('Show task execution logs', {'domain' : 'de.systopia.sqltasks'})}}
                </a>
                <a class="st__flex st__pb-10 st__gap-5 st__align-items-center" href="{{url('civicrm/sqltasks/global-token-manager');}}"
                  target="_blank"
                  title="{{ts('Global Token Manager', {'domain' : 'de.systopia.sqltasks'})}}">
                  <span class="crm-i fa-book"></span>
                  <span>{{ts('Global Token Manager', {'domain' : 'de.systopia.sqltasks'})}}</span>
                </a>
              </div>
              <div>
                <div ng-repeat="message in infoMessages" ng-bind-html="message.text" class="{{message.classes}}" ></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="crm-form-block">
      <div>
        <div class="st__pb-10 st__flex st__align-items-center st__justify-content-space-between">
          <div class="st__flex st__gap-5">
            <div class="st__ico">
              <i class="crm-i fa-bars"></i>
            </div>
            <div>{{ts('Displaying %1 of %2 tasks.', { '1' : displayTasks.length, '2' : tasks.length})}}</div>
          </div>
          <div>
            <div class="st__flex st__align-items-center st__gap-10">
              <div class="st__pr-10">{{ts('Display tasks that are:')}}</div>

              <div class="st__p-10 st__bg-enabled st__flex st__align-items-center st__cursor-pointer">
                <label class="st__cursor-pointer" for="isShowEnabledTask">{{ts('Enabled')}}</label>
                <input class="crm-form-checkbox st__m-0 st__cursor-pointer" ng-true-value="'1'" ng-false-value="'0'"
                  ng-change="redrawTaskList(); updatePreviousTaskOrder();"
                  ng-model="tasksDisplayPreferences.isShowEnabledTask" id="isShowEnabledTask" name="isShowEnabledTask" type="checkbox" >
              </div>

              <div class="st__p-10 st__bg-disabled st__flex st__align-items-center st__cursor-pointer">
                <label class="st__cursor-pointer" for="isShowDisabledTask">{{ts('Disabled')}}</label>
                <input class="crm-form-checkbox st__m-0 st__cursor-pointer" ng-true-value="'1'" ng-false-value="'0'"
                  ng-change="redrawTaskList(); updatePreviousTaskOrder();"
                  ng-model="tasksDisplayPreferences.isShowDisabledTask" id="isShowDisabledTask" name="isShowDisabledTask" type="checkbox" >
              </div>

              <div class="st__p-10 st__bg-archived st__flex st__align-items-center st__cursor-pointer">
                <label class="st__cursor-pointer" for="isShowArchivedTask">{{ts('Archived')}}</label>
                <input class="crm-form-checkbox st__m-0 st__cursor-pointer" ng-true-value="'1'" ng-false-value="'0'"
                  ng-change="redrawTaskList(); updatePreviousTaskOrder();"
                  ng-model="tasksDisplayPreferences.isShowArchivedTask" id="isShowArchivedTask" name="isShowArchivedTask" type="checkbox" >
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div>
      <table class="selector row-highlight stm__tasks-table">
        <thead>
        <tr>
          <th class="sorting_disabled" rowspan="1" colspan="1">{{ts('Category')}}</th>
          <th class="sorting_disabled" rowspan="1" colspan="1">{{ts('ID')}}</th>
          <th class="sorting_disabled" rowspan="1" colspan="1">{{ts('Name')}}</th>
          <th class="sorting_disabled" rowspan="1" colspan="1">{{ts('Description')}}</th>
          <th class="sorting_disabled" rowspan="1" colspan="1">{{ts('Enabled?')}}</th>
          <th class="sorting_disabled" rowspan="1" colspan="1">{{ts('Schedule')}}</th>
          <th class="sorting_disabled" rowspan="1" colspan="1">{{ts('Last Execution')}}</th>
          <th class="sorting_disabled" rowspan="1" colspan="1">{{ts('Last Runtime')}}</th>
          <th class="sorting_disabled" rowspan="1" colspan="1">{{ts('Selection Order')}}</th>
          <th class="sorting_disabled" rowspan="1" colspan="1"></th>
          <th class="sorting_disabled" rowspan="1" colspan="1"></th>
        </tr>
        </thead>
        <tbody ui-sortable="sortableOptions" id="sortable-tasks" class="ui-sortable" ng-model="displayTasks">
        <tr ng-repeat="task in displayTasks" id="{{task.id}}" data-task-id="{{task.id}}" class="sql-task-row-item"
            ng-class="{enabled : getNumberFromString(task.enabled), disabled : !getNumberFromString(task.enabled), 'odd-row': $odd, 'even-row': $even, archived: getNumberFromString(task.is_archived)}">
          <td>
            <div class="stm__table-column-category">{{task.category}}</div>
          </td>
          <td>[{{task.id}}]</td>
          <td>
            <div class="stm__table-column-name">{{task.name}}</div>
            <div ng-if="getNumberFromString(task.is_archived)" class="st__font-style-italic st__font-size-10">{{ts('Archived at %1', { '1' : task.archive_date})}}</div>
          </td>
          <td>
            <div class="stm__table-column-description" title="{{task.description}}">{{task.short_desc}}</div>
          </td>
          <td>{{getNumberFromString(task.enabled) ? 'Yes' : 'No'}}</td>
          <td>
            <span>{{task.schedule_label}}</span>
            <span ng-if="task.parallel_exec != 0"><strong>{{ts('(parallel)')}}</strong></span>
          </td>
          <td>
            <div class="stm__table-column-last-executed">{{task.last_executed}}</div>
          </td>
          <td>{{task.last_runtime}}</td>
          <td>
            <div class="st__flex">
              <a class="stm__weight-arrow crm-hover-button action-item" ng-click="moveTaskInList(task.id, 'top')" href="#">
                <img src="{{resourceBaseUrl}}i/arrow/first.gif" title="Move to top" alt="{{ts('Move to top')}}">
              </a>
              <a class="stm__weight-arrow crm-hover-button action-item" ng-click="moveTaskInList(task.id, 'up')" href="#">
                <img src="{{resourceBaseUrl}}i/arrow/up.gif" title="{{ts('Move up one row')}}" alt="Move up one row">
              </a>
              <a class="stm__weight-arrow crm-hover-button action-item" ng-click="moveTaskInList(task.id, 'down')" href="#">
                <img src="{{resourceBaseUrl}}i/arrow/down.gif" title="{{ts('Move down one row')}}" alt="Move down one row">
              </a>
              <a class="stm__weight-arrow crm-hover-button action-item" ng-click="moveTaskInList(task.id, 'bottom')" href="#">
                <img src="{{resourceBaseUrl}}i/arrow/last.gif" title="{{ts('Move to bottom')}}" alt="Move to bottom">
              </a>
            </div>
          </td>
          <td>
          <span class="btn-slide crm-hover-button btn-slide-active" ng-click="showPanelForTaskId(task.id)">
            {{ts('Actions', {'domain' : 'de.systopia.sqltasks'})}}
            <ul ng-if="taskIdWithOpenPanel == task.id" class="panel">
              <li ng-if="!getNumberFromString(task.is_archived)" >
                <a ng-click="onExecutePress(task.id)" class="stm__action-item action-item crm-hover-button"
                   title="{{ts('Run this task now', {'domain' : 'de.systopia.sqltasks'})}}"
                   crm-icon="fa-play">
                  <span>{{ts('Run Now', {'domain' : 'de.systopia.sqltasks'})}}</span>
                </a>
              </li>
              <li>
                <a ng-href="#/sqltasks/configure/{{task.id}}"
                   class="stm__action-item action-item crm-hover-button"
                   title="{{ts('Configure', {'domain' : 'de.systopia.sqltasks'})}}"
                   crm-icon="fa-pencil">
                  <span>
                    {{ts(getNumberFromString(task.is_archived) ? 'Configure (read-only)' : 'Configure', {'domain' : 'de.systopia.sqltasks'})}}
                  </span>
                </a>
              </li>
              <li ng-if="!getNumberFromString(task.is_archived)" >
                <a ng-if="getNumberFromString(task.enabled)" ng-click="onToggleEnablePress(task.id, 0)"
                   class="stm__action-item action-item crm-hover-button"
                   title="{{ts('Disable for scheduled execution', {'domain' : 'de.systopia.sqltasks'})}}"
                   crm-icon="fa-stop-circle">
                  <span>{{ts('Disable', {'domain' : 'de.systopia.sqltasks'})}}</span>
                </a>
                <a ng-if="!getNumberFromString(task.enabled)" ng-click="onToggleEnablePress(task.id, 1)"
                   class="stm__action-item action-item crm-hover-button"
                   title="{{ts('Enable for scheduled execution', {'domain' : 'de.systopia.sqltasks'})}}"
                   crm-icon="fa-play-circle">
                  <span>{{ts('Enable', {'domain' : 'de.systopia.sqltasks'})}}</span>
                </a>
              </li>
              <li>
                <a ng-href="/civicrm/sqltasks/export?id={{task.id}}"
                   class="stm__action-item action-item crm-hover-button"
                   title="{{ts('Export Configuration', {'domain' : 'de.systopia.sqltasks'})}}"
                   crm-icon="fa-download">
                  <span>{{ts('Export Config', {'domain' : 'de.systopia.sqltasks'})}}</span>
                </a>
              </li>
              <li ng-if="!getNumberFromString(task.is_archived)" >
                <a ng-href="#/sqltasks/import/{{task.id}}"
                   class="stm__action-item action-item crm-hover-button"
                   title="{{ts('Import Configuration', {'domain' : 'de.systopia.sqltasks'})}}"
                   crm-icon="fa-upload">
                  <span>{{ts('Import Config', {'domain' : 'de.systopia.sqltasks'})}}</span>
                </a>
              </li>
              <li>
                <a href="{{url('civicrm/sqltasks-execution/list', {'sqltask_id' : task.id});}}"
                   class="stm__action-item action-item crm-hover-button"
                   title="{{ts('Show all execution logs', {'domain' : 'de.systopia.sqltasks'})}}"
                   crm-icon="fa-bars">
                  <span>{{ts('Show Execution logs', {'domain' : 'de.systopia.sqltasks'})}}</span>
                </a>
              </li>
              <li>
                <a href="{{url('civicrm/sqltasks-execution/latest-logs', {'sqltask_id' : task.id});}}"
                   class="stm__action-item action-item crm-hover-button"
                   title="{{ts('Show latest execution logs', {'domain' : 'de.systopia.sqltasks'})}}"
                   crm-icon="fa-eye">
                  <span>{{ts('Show latest execution', {'domain' : 'de.systopia.sqltasks'})}}</span>
                </a>
              </li>
              <li>
                <a ng-click="showWhereTaskIsUsed(task.id)"
                   class="stm__action-item action-item crm-hover-button"
                   title="{{ts('Show all tasks which contain a reference to this task', {'domain' : 'de.systopia.sqltasks'})}}"
                   crm-icon="fa-link">
                  <span>{{ts('Show References', {'domain' : 'de.systopia.sqltasks'})}}</span>
                </a>
              </li>
              <li>
                <a ng-click="onDeletePress(task.id)" class="stm__action-item action-item crm-hover-button"
                   title="{{ts('Delete Task', {'domain' : 'de.systopia.sqltasks'})}}"
                   crm-icon="fa-trash">
                  <span>{{ts('Delete', {'domain' : 'de.systopia.sqltasks'})}}</span>
                </a>
              </li>
              <li ng-if="!getNumberFromString(task.is_archived) && !getNumberFromString(task.enabled)" >
                <a ng-click="onArchivePress(task.id)" class="stm__action-item action-item crm-hover-button"
                   title="{{ts('Archive', {'domain' : 'de.systopia.sqltasks'})}}"
                   crm-icon="fa-archive">
                  <span>{{ts('Archive', {'domain' : 'de.systopia.sqltasks'})}}</span>
                </a>
              </li>
              <li ng-if="getNumberFromString(task.is_archived)" >
                <a ng-click="onUnarchivePress(task.id)" class="stm__action-item action-item crm-hover-button"
                   title="{{ts('Unarchive task', {'domain' : 'de.systopia.sqltasks'})}}"
                   crm-icon="fa-undo">
                  <span>{{ts('Unarchive', {'domain' : 'de.systopia.sqltasks'})}}</span>
                </a>
              </li>
            </ul>
          </span>
          </td>
          <td class="handle-drag" style="cursor: move;">
            <div>&#8693;</div>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
